<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mb-4">Toplantılar</h2>
      <button class="btn btn-primary" (click)="openCreate()">+ Yeni Toplantı</button>
    </div>
  
    <div *ngIf="loading" class="alert alert-info">Yükleniyor...</div>
  
    <table class="table table-striped" *ngIf="!loading && meetings.length > 0">
      <thead>
        <tr>
          <th>Başlık</th>
          <th>Açıklama</th>
          <th>Başlangıç</th>
          <th>Bitiş</th>
          <th>Katılımcılar</th>
          <th>Durum</th>
          <th style="width:160px">İşlemler</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let m of meetings">
          <td>{{ m.title }}</td>
          <td class="text-truncate" style="max-width:300px">{{ m.description }}</td>
          <td>{{ m.startDate | date:'short' }}</td>
          <td>{{ m.endDate | date:'short' }}</td>
          <td>{{ mapParticipantsToLabels(m.participants) }}</td>
          <td>{{ m.status || 'active' }}</td>
          <td>
            <button class="btn btn-sm btn-warning me-2" (click)="openEdit(m)">Düzenle</button>
            <button class="btn btn-sm btn-danger" (click)="deleteMeeting(m.id)">Sil</button>
          </td>
        </tr>
      </tbody>
    </table>
  
    <div *ngIf="!loading && meetings.length === 0" class="alert alert-warning">
      Henüz toplantı yok.
    </div>
  </div>
  
  <!-- Modal -->
  <div
    class="modal fade show"
    *ngIf="showModal"
    tabindex="-1"
    aria-modal="true"
    role="dialog"
    style="display:block; background:rgba(0,0,0,.5)"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <form #meetingForm="ngForm" (ngSubmit)="save(meetingForm)" novalidate>
          <div class="modal-header">
            <h5 class="modal-title">Toplantı {{ editingId ? 'Düzenle' : 'Ekle' }}</h5>
            <button type="button" class="btn-close" aria-label="Kapat" (click)="closeModal()"></button>
          </div>
  
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Başlık</label>
              <input [(ngModel)]="form.title" name="title" required class="form-control" />
            </div>
  
            <div class="mb-3">
              <label class="form-label">Açıklama</label>
              <textarea [(ngModel)]="form.description" name="description" class="form-control" rows="3"></textarea>
            </div>
  
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Başlangıç</label>
                <input
                  [(ngModel)]="form.startDate"
                  name="startDate"
                  type="datetime-local"
                  required
                  class="form-control"
                />
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Bitiş</label>
                <input
                  [(ngModel)]="form.endDate"
                  name="endDate"
                  type="datetime-local"
                  required
                  class="form-control"
                />
              </div>
            </div>
  
            <!-- Katılımcılar (Bootstrap dropdown + checkbox'lı çoklu seçim) -->
            <div class="mb-3">
              <label class="form-label d-flex justify-content-between align-items-center">
                <span>Katılımcılar</span>
                <small class="text-muted" *ngIf="usersLoading">Yükleniyor…</small>
              </label>
  
              <div class="dropdown w-100">
                <button
                  class="btn btn-outline-secondary w-100 text-start d-flex justify-content-between align-items-center"
                  type="button"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  <span class="text-truncate">
                    <ng-container *ngIf="form.participants?.length; else secilmedi">
                      {{ form.participants.length }} kişi seçildi
                    </ng-container>
                    <ng-template #secilmedi> Katılımcı seçin </ng-template>
                  </span>
                  <span class="ms-2 bi bi-chevron-down"></span>
                </button>
  
                <div class="dropdown-menu p-2 w-100 shadow participants-dropdown" (click)="$event.stopPropagation()">
                  <input
                    class="form-control form-control-sm mb-2"
                    placeholder="Ara (ad, soyad, email)"
                    [(ngModel)]="userFilter"
                    name="userFilter"
                    [ngModelOptions]="{standalone: true}"
                  />
  
                  <div class="participants-list">
                    <label
                      class="form-check d-flex align-items-center gap-2 py-1 px-1"
                      *ngFor="let u of filteredUsers"
                    >
                      <input
                        class="form-check-input"
                        type="checkbox"
                        [checked]="isSelected(u.email)"
                        (change)="toggleParticipant(u.email, $event.target.checked)"
                      />
                      <span class="form-check-label">
                        {{ u.firstName }} {{ u.lastName }}
                        <small class="text-muted">({{ u.email }})</small>
                      </span>
                    </label>
  
                    <div *ngIf="!usersLoading && filteredUsers?.length === 0" class="text-muted small px-1 py-2">
                      Sonuç bulunamadı.
                    </div>
                  </div>
  
                  <div class="d-flex justify-content-end gap-2 mt-2">
                    <button type="button" class="btn btn-sm btn-outline-secondary" (click)="form.participants = []">
                      Temizle
                    </button>
                    <button type="button" class="btn btn-sm btn-primary" (click)="$event.stopPropagation();">
                      Tamam
                    </button>
                  </div>
                </div>
              </div>
  
              <!-- Seçili katılımcı etiketleri -->
              <div class="mt-2" *ngIf="form.participants?.length">
                <span class="badge text-bg-secondary me-1 mb-1" *ngFor="let p of form.participants">
                  {{ userLabelMap[p] || p }}
                </span>
              </div>
            </div>
  
            <div class="mb-3">
              <label class="form-label">Durum</label>
              <select [(ngModel)]="form.status" name="status" class="form-select">
                <option value="">Seçiniz</option>
                <option value="active">Aktif</option>
                <option value="cancelled">İptal</option>
              </select>
            </div>
          </div>
  
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeModal()">İptal</button>
            <button class="btn btn-primary" [disabled]="meetingForm.invalid">
              {{ editingId ? 'Güncelle' : 'Kaydet' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  